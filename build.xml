<?xml version="1.0" encoding="UTF-8" ?>
<project default="deploy">
	<!-- Precompile the Java Code -->
	<target name="compile">
		<mkdir dir="${java.io.tmpdir}/afv/build/classes" />
		<javac srcdir="src/java" optimize="on" destdir="${java.io.tmpdir}/afv/build/classes"
		 debug="true" debuglevel="lines,vars,source" source="1.5" target="1.5"
		 compiler="modern">
			<compilerarg value="-Xlint:unchecked" />
	    	<classpath id="afv.classpath">
				<fileset dir="${ant.home}/lib" includes="*.jar" />
				<fileset dir="../DVA2006/lib" includes="**/*.jar" />
				<pathelement location="${java.io.tmpdir}/build/dva2006.jar" />
	    	</classpath>
		</javac>
		
		<!-- Compress the Java classes into a single JAR file -->
		<jar basedir="${java.io.tmpdir}/afv/build/classes" compress="true" index="true"
			 destfile="${java.io.tmpdir}/afv/build/afv2006.jar" />
	</target>
	
	<!-- Precompile the JSP pages -->
	<target name="jspc" depends="compile">
		<property name="jspc.dva.webXMLInc" value="${java.io.tmpdir}/src/jsp/include.xml" />
		<property name="jspc.afv.webXMLInc" value="${java.io.tmpdir}/afv/src/jsp/include.xml" />
		<taskdef classname="org.apache.jasper.JspC" name="jasper2"> 
			<classpath id="afv.jspc.classpath"> 
				<fileset dir="${ant.home}/lib" includes="*.jar" />
				<fileset dir="../DVA2006/lib/jspc" includes="*.jar" />
				<fileset dir="../DVA2006/lib" includes="**/*.jar" />
				<pathelement location="${java.io.tmpdir}/build/dva2006.jar" />
				<pathelement location="${java.io.tmpdir}/afv/build/afv2006.jar" />
			</classpath> 
		</taskdef>
		
		<!-- Delete the old web.xml -->
		<delete file="${java.io.tmpdir}/afv/build/web.xml" />
		
		<!-- Copy the new web.xml and TLD files from DVA2006 -->
		<copy file="WEB-INF/web_core.xml" tofile="WEB-INF/web.xml" />
		<copy todir="WEB-INF">
			<fileset dir="../DVA2006/WEB-INF" includes="*.tld" />
		</copy>
		
		<!-- Copy the main header files -->
		<copy todir="jsp/main" overwrite="false">
			<fileset dir="../DVA2006/jsp/main" excludes="home.jsp" />
		</copy>
		
		<!-- Rename the include JSPs to framgments -->
		<move file="jsp/main/header.jsp" tofile="jsp/main/header.jspf" />
		<move file="jsp/main/sideMenu.jsp" tofile="jsp/main/sideMenu.jspf" />
		
		<!-- Precompile the files -->
		<mkdir dir="${java.io.tmpdir}/afv/src/jsp" />
	    <jasper2 package="net.afva" uriroot="${basedir}" verbose="0" poolingEnabled="false" 
	    	xpoweredBy="true" validateXml="false" webXmlFragment="${jspc.afv.webXMLInc}"
	    	compilerTargetVM="1.5" compilerSourceVM="1.5" trimSpaces="true"
	    	outputDir="${java.io.tmpdir}/afv/src/jsp" />
		
		<!-- Clean up -->
		<delete>
			<fileset dir="WEB-INF" includes="web.xml,*.tld" />
			<fileset dir="jsp/main" excludes="afvHome.jsp" />
		</delete>

		<!-- Compile the files -->
		<mkdir dir="${java.io.tmpdir}/afv/build/jsp" />
		<javac srcdir="${java.io.tmpdir}/afv/src/jsp" destdir="${java.io.tmpdir}/afv/build/jsp"
			debug="on" debuglevel="source" optimize="on" target="1.5" source="1.5" nowarn="on">
			<classpath refid="afv.jspc.classpath" />
			<include name="net/afva/jsp/**/*.java" />
		</javac>

		<!-- Compress the Java classes into a single JAR file -->
		<jar basedir="${java.io.tmpdir}/afv/build/jsp" compress="true" index="true"
		 	destfile="${java.io.tmpdir}/afv/build/afv2006_jsp.jar" />
		
		<!-- Force all JSPs to load on startup -->
		<!-- <replace file="${jspc.afv.webXMLInc}" token="&lt;/servlet-class&gt;">
			<replacevalue><![CDATA[</servlet-class>
        <load-on-startup>2</load-on-startup>]]></replacevalue>
		</replace> -->
		 		 
		<!-- Merge the precompile definitions into web.xml -->
		<loadfile property="afv.webXmlFragment" srcFile="${jspc.afv.webXMLInc}" />
		<loadfile property="dva.webXmlFragment" srcFile="${jspc.dva.webXMLInc}" />		
		<copy file="WEB-INF/web_core.xml" tofile="${java.io.tmpdir}/afv/build/web.xml" />
		<replace file="${java.io.tmpdir}/afv/build/web.xml" 
			token="&lt;!-- [INSERT DVA FRAGMENT HERE] --&gt;" value="${dva.webXmlFragment}" />
		<replace file="${java.io.tmpdir}/afv/build/web.xml" 
			token="&lt;!-- [INSERT AFV FRAGMENT HERE] --&gt;" value="${afv.webXmlFragment}" />
	</target>
	
	<target name="deploy" depends="jspc">
		<!-- Load the FTP server properties -->
		<property name="path.webapp" value="/afv2006" />
		<property name="path.http" value="/afv2006" />
		<loadproperties srcFile="data/build_deploy.properties" />
		
		<!-- Upload the root data to the FTP server -->
		<echo message="Uploading WEB-INF configuration data" />
		<ftp server="${webapp.ftp.server}" userid="${webapp.ftp.user}" password="${webapp.ftp.pwd}"
		 remotedir="${path.webapp}/WEB-INF" action="send" depends="yes" verbose="yes">
	    	<fileset dir="WEB-INF">
	    		<include name="*.tld" />
			</fileset>
			<fileset dir="../DVA2006/WEB-INF">
				<include name="*.tld" />
			</fileset>
			<fileset file="${java.io.tmpdir}/afv/build/web.xml" />
		</ftp>
		
		<!-- Upload the libraries to the FTP server -->
		<echo message="Uploading Library Jars" />
		<ftp server="${webapp.ftp.server}" userid="${webapp.ftp.user}" password="${webapp.ftp.pwd}"
		 remotedir="${path.webapp}/WEB-INF/lib" action="send" depends="yes" verbose="yes">
			<fileset dir="../DVA2006/lib/deploy">
				<include name="mysql*.jar" />
				<include name="log4j*.jar" />
			</fileset>
			<fileset dir="${java.io.tmpdir}/afv/build" includes="*.jar" />
			<fileset dir="${java.io.tmpdir}/build">
				<include name="dva2006.jar" />
				<include name="dva2006_jsp.jar" />
			</fileset>
		</ftp>
		
		<!-- Upload the libraries to the FTP server -->
		<echo message="Uploading common Library Jars" />
		<ftp server="${webapp.ftp.server}" userid="${webapp.ftp.user}" password="${webapp.ftp.pwd}"
		 remotedir="${webapp.ftp.path.common}" action="send" depends="yes" verbose="yes">
			<fileset dir="../DVA2006/lib/deploy">
				<exclude name="mysql*.jar" />
				<exclude name="log4j*.jar" />
			</fileset>
		</ftp>
		
		<!-- Upload configuration files to the FTP server -->
		<echo message="Uploading Configuration files" />
		<ftp server="${webapp.ftp.server}" userid="${webapp.ftp.user}" password="${webapp.ftp.pwd}"
		 remotedir="${path.webapp}/WEB-INF/classes/etc" action="send" depends="yes" verbose="yes">
			<fileset dir="etc" includes="*.*" />
		</ftp>
		
		<!-- Upload static content to the HTTP server -->
		<echo message="Uploading static content to HTTP server" />
		<ftp server="${http.ftp.server}" userid="${http.ftp.user}" password="${http.ftp.pwd}"
		 remotedir="${path.http}" action="send" depends="yes" verbose="yes">
			<fileset dir="static" includes="**/*" />
		</ftp>
	</target>
	
	<!-- Clean out compiled data -->
	<target name="clean">
		<delete dir="${java.io.tmpdir}/build" />
		<delete dir="${java.io.tmpdir}/src/jsp" />
		<delete file="${java.io.tmpdir}/build/web.xml" />
	</target>
	
	<!-- Production Deployment via SSH -->
	<target name="prod_deploy" depends="jspc">
		<loadproperties srcFile="data/build_deploy.properties" />
		
		<!-- Upload the web configuration -->
		<scp todir="${webapp.ssh.user}@${webapp.ssh.server}:${webapp.ssh.path}/WEB-INF"
			verbose="yes" trust="yes" password="${webapp.ssh.pwd}">
	    	<fileset dir="../DVA2006/WEB-INF">
	    		<include name="*.tld" />
				<modified seldirs="false" algorithm="digest">
						<param name="algorithm.algorithm" value="MD5" />
						<param name="cache.cachefile" value="../.local_data/afv.cfg.cache.txt" />
				</modified>
			</fileset>
			<fileset file="${java.io.tmpdir}/afv/build/web.xml">
				<modified seldirs="false" algorithm="digest">
					<param name="algorithm.algorithm" value="MD5" />
					<param name="cache.cachefile" value="../.local_data/afv.cfg.cache.txt" />
				</modified>
			</fileset>
		</scp>
		
		<!-- Upload the common JAR files to the app server -->
		<scp todir="${webapp.ssh.user}@${webapp.ssh.server}:${webapp.ssh.path.common}"
			verbose="yes" trust="yes" password="${webapp.ssh.pwd}">
			<fileset dir="../DVA2006/lib/deploy" includes="*.jar">
				<exclude name="mysql*.jar" />
				<exclude name="log4j*.jar" />
				<modified seldirs="false" algorithm="digest">
					<param name="algorithm.algorithm" value="MD5" />
					<param name="cache.cachefile" value="../.local_data/jar.cache.txt" />
				</modified>
			</fileset>
		</scp>

		<!-- Upload the JAR files to the app server -->
		<scp todir="${webapp.ssh.user}@${webapp.ssh.server}:${webapp.ssh.path}/WEB-INF/lib"
			verbose="yes" trust="yes" password="${webapp.ssh.pwd}">
			<fileset dir="../DVA2006/lib/deploy">
				<include name="mysql*.jar" />
				<include name="log4j*.jar" />
				<modified seldirs="false" algorithm="digest">
					<param name="algorithm.algorithm" value="MD5" />
					<param name="cache.cachefile" value="../.local_data/afv.jar.cache.txt" />
				</modified>
			</fileset>
			<fileset dir="${java.io.tmpdir}/build">
				<include name="dva2006.jar" />
				<include name="dva2006_jsp.jar" />
				<modified seldirs="false" algorithm="digest">
					<param name="algorithm.algorithm" value="MD5" />
					<param name="cache.cachefile" value="../.local_data/afv.jar.cache.txt" />
				</modified>
			</fileset>
			<fileset dir="${java.io.tmpdir}/afv/build">
				<include name="*.jar" />
				<modified seldirs="false" algorithm="digest">
					<param name="algorithm.algorithm" value="MD5" />
					<param name="cache.cachefile" value="../.local_data/afv.jar.cache.txt" />
				</modified>
			</fileset>
		</scp>
		
		<!-- Upload the config file to the app server -->
		<scp todir="${webapp.ssh.user}@${webapp.ssh.server}:${webapp.ssh.path}/WEB-INF/classes/etc"
			verbose="yes" trust="yes" password="${webapp.ssh.pwd}">
			<fileset dir="etc">
				<include name="commands.xml" />
				<include name="services.xml" />
				<include name="profanity.txt" />
				<modified seldirs="false" algorithm="digest">
						<param name="algorithm.algorithm" value="MD5" />
						<param name="cache.cachefile" value="../.local_data/afv.cfg.cache.txt" />
				</modified>
			</fileset>
			<fileset dir="etc/prod">
				<modified seldirs="false" algorithm="digest">
						<param name="algorithm.algorithm" value="MD5" />
						<param name="cache.cachefile" value="../.local_data/afv.cfg.cache.txt" />
				</modified>
			</fileset>
		</scp>
		
		<!-- Upload static content to the HTTP server -->
		<scp todir="${http.ssh.user}@${http.ssh.server}:${http.ssh.path}"
			verbose="yes" trust="yes" password="${http.ssh.pwd}">
			<fileset dir="static">
				<modified seldirs="true" algorithm="digest">
						<param name="algorithm.algorithm" value="MD5" />
						<param name="cache.cachefile" value="../.local_data/afv.static.cache.txt" />
				</modified>
			</fileset>
		</scp>
	</target>
</project>
